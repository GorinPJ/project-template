# 障害対応手順

## 概要

システム障害発生時の対応手順を記載します。

---

## 障害レベル定義

| レベル | 定義 | 対応時間 | エスカレーション |
|-------|------|---------|----------------|
| Critical | サービス全停止、データ損失の恐れ | 即時 | 即座に責任者へ |
| Major | 主要機能が使用不可 | 1時間以内 | 30分以内に報告 |
| Minor | 一部機能に問題あり | 4時間以内 | 次営業日報告 |
| Warning | 軽微な問題、監視アラート | 翌営業日 | 定例報告 |

---

## 障害対応フロー

```
┌─────────────────────────────────────────────────────────────┐
│  1. 検知                                                    │
│     - 監視アラート / ユーザー報告 / 目視確認                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  2. 一次対応                                                │
│     - 状況確認、影響範囲特定、障害レベル判定                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  3. エスカレーション                                         │
│     - 障害レベルに応じて報告                                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  4. 原因調査・復旧作業                                       │
│     - ログ調査、原因特定、復旧対応                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  5. 復旧確認                                                │
│     - サービス正常性確認                                     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  6. 事後対応                                                │
│     - 報告書作成、振り返り、再発防止策                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 一次対応チェックリスト

### 状況確認

- [ ] 障害発生日時を記録
- [ ] 影響範囲を確認（全体/一部、ユーザー数）
- [ ] エラーメッセージを記録
- [ ] 直前の変更有無を確認（デプロイ、設定変更等）

### 障害レベル判定

| 確認項目 | Critical | Major | Minor |
|---------|----------|-------|-------|
| サービス停止 | 全停止 | 一部停止 | 軽微な問題 |
| 影響ユーザー | 全員 | 多数 | 少数 |
| データ影響 | あり | 可能性あり | なし |
| 代替手段 | なし | なし | あり |

---

## エスカレーションパス

```
障害検知
    │
    ├─→ Critical/Major
    │       │
    │       ├─→ 運用担当 (即時)
    │       │       │
    │       │       └─→ 開発責任者 (15分以内)
    │       │               │
    │       │               └─→ PM/PO (30分以内)
    │       │                       │
    │       │                       └─→ 経営層 (必要に応じて)
    │       │
    │       └─→ ユーザー告知 (30分以内)
    │
    └─→ Minor/Warning
            │
            └─→ 運用担当 → 開発担当
```

### 連絡先

| 役割 | 氏名 | 電話 | メール | 対応時間 |
|------|------|------|-------|---------|
| 運用担当（主） | | | | 24/7 |
| 運用担当（副） | | | | 24/7 |
| 開発責任者 | | | | 9:00-22:00 |
| PM | | | | 9:00-18:00 |

---

## よくある障害と対応

### サービス応答なし

#### 症状
- Webサイトにアクセスできない
- API呼び出しがタイムアウト

#### 確認手順
```bash
# 1. ヘルスチェック
curl -I https://example.com/api/health

# 2. ECSタスク状態確認
aws ecs describe-services --cluster production --services app

# 3. ALB状態確認
aws elbv2 describe-target-health --target-group-arn {arn}
```

#### 対応
1. タスク数を確認、不足していれば増加
2. タスクが起動失敗の場合はログを確認
3. 必要に応じて前バージョンにロールバック

---

### データベース接続エラー

#### 症状
- 「接続できません」エラー
- タイムアウトエラー

#### 確認手順
```bash
# 1. RDSインスタンス状態確認
aws rds describe-db-instances --db-instance-identifier production

# 2. 接続数確認
# CloudWatchでDatabaseConnectionsメトリクスを確認

# 3. 踏み台からの接続確認
mysql -h db.example.com -u admin -p
```

#### 対応
1. RDSインスタンスの状態を確認
2. 接続数上限に達している場合は不要な接続を切断
3. フェイルオーバー発生時は新しいエンドポイントを確認

---

### ディスク容量不足

#### 症状
- ログ書き込みエラー
- ファイルアップロード失敗

#### 確認手順
```bash
# EC2の場合
df -h

# ECSの場合
# CloudWatchでStorageメトリクスを確認
```

#### 対応
1. 不要なログファイルを削除
2. 古いデータのアーカイブ
3. ディスク拡張（必要な場合）

---

### 高負荷・スローダウン

#### 症状
- レスポンスが遅い
- タイムアウト増加

#### 確認手順
```bash
# 1. CPU/メモリ使用率確認
# CloudWatchダッシュボードを確認

# 2. スロークエリ確認
# RDS Performance Insightsを確認

# 3. アクセス数確認
# ALBメトリクスを確認
```

#### 対応
1. 不正アクセスの場合はIP遮断
2. スロークエリの改善
3. スケールアウト

---

## 報告テンプレート

### 障害発生報告（初報）

```
【障害発生報告】

■ 発生日時: YYYY-MM-DD HH:MM

■ 障害レベル: Critical / Major / Minor

■ 影響範囲:
- 影響サービス:
- 影響ユーザー数:

■ 症状:

■ 現在の状況:

■ 対応状況:

■ 次回報告予定: HH:MM
```

### 障害復旧報告

```
【障害復旧報告】

■ 発生日時: YYYY-MM-DD HH:MM
■ 復旧日時: YYYY-MM-DD HH:MM
■ 障害時間: X時間XX分

■ 影響範囲:

■ 原因:

■ 対応内容:

■ 再発防止策:

■ 添付: 詳細報告書（後日提出）
```

---

## 振り返り（ポストモーテム）

### 振り返り項目

1. タイムライン
2. 根本原因分析（5 Whys）
3. 影響
4. 良かった点
5. 改善点
6. アクションアイテム

### アクションアイテム例

| # | 項目 | 担当 | 期限 | ステータス |
|---|------|------|------|-----------|
| 1 | 監視アラート閾値の見直し | | | |
| 2 | 復旧手順書の更新 | | | |
| 3 | 再発防止策の実装 | | | |

---

**最終更新**: YYYY-MM-DD
**更新者**: {名前}
