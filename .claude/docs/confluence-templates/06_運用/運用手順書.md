# 運用手順書

## 概要

本システムの日常運用手順を記載します。

---

## システム情報

### 環境一覧

| 環境 | URL | 用途 |
|------|-----|------|
| 本番 | https://example.com | 本番サービス |
| ステージング | https://stg.example.com | リリース前確認 |
| 開発 | https://dev.example.com | 開発・テスト |

### インフラ構成

| コンポーネント | サービス | 備考 |
|--------------|---------|------|
| Webサーバー | AWS ECS | 3台構成 |
| データベース | AWS RDS (MySQL) | Multi-AZ |
| キャッシュ | AWS ElastiCache (Redis) | クラスター構成 |
| ストレージ | AWS S3 | |
| CDN | AWS CloudFront | |
| 監視 | AWS CloudWatch | |

### アクセス情報

| 項目 | 接続先 | 備考 |
|------|-------|------|
| AWSコンソール | https://console.aws.amazon.com | IAMユーザーでログイン |
| SSH踏み台 | bastion.example.com | 秘密鍵必要 |
| DBクライアント | db.example.com:3306 | 踏み台経由 |

---

## 日次運用

### 朝の確認作業

| # | 作業 | 確認内容 | 担当 |
|---|------|---------|------|
| 1 | 監視アラート確認 | 夜間のアラート有無 | 運用担当 |
| 2 | ヘルスチェック | 各サービスの死活確認 | 運用担当 |
| 3 | ログ確認 | エラーログの確認 | 運用担当 |
| 4 | バッチ実行結果確認 | 夜間バッチの成功確認 | 運用担当 |

### ヘルスチェック

```bash
# APIヘルスチェック
curl https://example.com/api/health

# 期待レスポンス
{
  "status": "healthy",
  "database": "connected",
  "cache": "connected"
}
```

### ログ確認

| ログ | 場所 | 確認ポイント |
|------|------|------------|
| アプリログ | CloudWatch Logs | ERRORレベルのログ |
| アクセスログ | CloudWatch Logs | 5xxエラーの有無 |
| DBスロークエリ | RDS Performance Insights | 長時間クエリ |

---

## 定期作業

### 週次作業

| 作業 | 実施日 | 内容 |
|------|-------|------|
| パフォーマンスレビュー | 月曜 | 週間のメトリクス確認 |
| バックアップ確認 | 水曜 | バックアップの成功確認 |
| ディスク容量確認 | 金曜 | 空き容量の確認 |

### 月次作業

| 作業 | 実施日 | 内容 |
|------|-------|------|
| パッチ適用 | 第2土曜 | セキュリティパッチ適用 |
| 証明書確認 | 月初 | SSL証明書の期限確認 |
| コスト確認 | 月初 | AWS利用料の確認 |

---

## デプロイ手順

### 本番デプロイ

#### 前提条件

- [ ] ステージング環境での動作確認完了
- [ ] リリース承認済み
- [ ] メンテナンス告知済み（必要な場合）

#### 手順

```bash
# 1. 現状確認
aws ecs describe-services --cluster production --services app

# 2. タグ確認
git tag -l

# 3. デプロイ実行
./scripts/deploy.sh production v1.2.3

# 4. デプロイ完了確認
aws ecs describe-services --cluster production --services app
# runningCountがdesiredCountと一致することを確認

# 5. ヘルスチェック
curl https://example.com/api/health

# 6. 動作確認
# 主要機能の確認を実施
```

#### ロールバック手順

```bash
# 問題発生時のロールバック
./scripts/deploy.sh production v1.2.2  # 前バージョンを指定

# 緊急時はAWSコンソールから
# ECS > サービス > タスク定義のリビジョンを変更
```

---

## バッチ処理

### バッチ一覧

| バッチ名 | スケジュール | 内容 | 所要時間 |
|---------|------------|------|---------|
| 日次集計 | 毎日 2:00 | 前日分のデータ集計 | 約30分 |
| 週次レポート | 毎週月曜 3:00 | 週次レポート生成 | 約1時間 |
| 月次締め | 毎月1日 4:00 | 月次締め処理 | 約2時間 |
| データ削除 | 毎日 5:00 | 古いログの削除 | 約15分 |

### バッチ手動実行

```bash
# 日次集計の手動実行
aws ecs run-task \
  --cluster production \
  --task-definition batch-daily \
  --overrides '{"containerOverrides":[{"name":"batch","command":["npm","run","batch:daily"]}]}'
```

### バッチ失敗時の対応

1. ログを確認して原因特定
2. 必要に応じてデータ修正
3. 手動で再実行
4. 成功を確認

---

## バックアップ・リストア

### バックアップ

| 対象 | 方式 | 頻度 | 保持期間 |
|------|------|------|---------|
| DB | RDS自動バックアップ | 日次 | 30日 |
| DB | 手動スナップショット | 月次 | 1年 |
| ファイル | S3バージョニング | 常時 | 90日 |

### リストア手順

```bash
# RDSスナップショットからリストア
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier restored-db \
  --db-snapshot-identifier rds:production-2024-01-15-02-00

# リストア完了後、接続確認
mysql -h restored-db.xxxxx.rds.amazonaws.com -u admin -p
```

---

## メンテナンス

### 計画メンテナンス

#### 事前準備

1. メンテナンス日時を決定
2. 影響範囲を確認
3. ユーザーへの告知（1週間前）
4. 作業手順書の作成
5. ロールバック手順の確認

#### メンテナンス作業

```bash
# 1. メンテナンスモードON
./scripts/maintenance.sh on

# 2. 作業実施
# ...

# 3. 動作確認

# 4. メンテナンスモードOFF
./scripts/maintenance.sh off
```

---

## 連絡先

| 役割 | 氏名 | 連絡先 | 備考 |
|------|------|-------|------|
| 運用責任者 | | | 平日 9:00-18:00 |
| 開発責任者 | | | |
| インフラ担当 | | | |
| AWSサポート | - | AWS Console | |

---

**最終更新**: YYYY-MM-DD
**更新者**: {名前}
