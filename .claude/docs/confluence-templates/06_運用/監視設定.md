# 監視設定

## 概要

システム監視の設定と運用方法を記載します。

---

## 監視ツール

| ツール | 用途 | URL |
|--------|------|-----|
| AWS CloudWatch | インフラ・アプリ監視 | AWS Console |
| Datadog | APM・ログ管理 | https://app.datadoghq.com |
| PagerDuty | アラート通知 | https://xxx.pagerduty.com |
| Slack | 通知受信 | #alerts チャンネル |

---

## 監視項目

### インフラ監視

| 対象 | メトリクス | 閾値（警告） | 閾値（障害） | 確認間隔 |
|------|-----------|------------|------------|---------|
| EC2/ECS | CPU使用率 | 70% | 90% | 1分 |
| EC2/ECS | メモリ使用率 | 70% | 90% | 1分 |
| EBS | ディスク使用率 | 70% | 90% | 5分 |
| RDS | CPU使用率 | 70% | 90% | 1分 |
| RDS | 接続数 | 80% | 95% | 1分 |
| RDS | ストレージ空き容量 | 20GB | 10GB | 5分 |
| ElastiCache | メモリ使用率 | 70% | 90% | 1分 |

### アプリケーション監視

| 対象 | メトリクス | 閾値（警告） | 閾値（障害） | 確認間隔 |
|------|-----------|------------|------------|---------|
| ALB | 5xxエラー率 | 1% | 5% | 1分 |
| ALB | 4xxエラー率 | 5% | 10% | 1分 |
| ALB | レイテンシ (p99) | 3秒 | 10秒 | 1分 |
| API | ヘルスチェック | - | 失敗 | 1分 |
| API | エラー率 | 1% | 5% | 1分 |

### 外形監視

| 対象 | 内容 | 閾値 | 確認間隔 |
|------|------|------|---------|
| トップページ | HTTP 200 | レスポンスなし | 1分 |
| ログインページ | HTTP 200 | レスポンスなし | 1分 |
| API ヘルスチェック | HTTP 200 + JSON確認 | 異常レスポンス | 1分 |

### ログ監視

| ログ種別 | 監視パターン | 閾値 | アラート |
|---------|------------|------|---------|
| アプリログ | ERROR | 10件/分 | 警告 |
| アプリログ | CRITICAL | 1件 | 障害 |
| アクセスログ | 5xx | 10件/分 | 警告 |
| セキュリティログ | 認証失敗 | 50件/分 | 警告 |

---

## アラート設定

### アラートレベル

| レベル | 通知先 | 対応 |
|-------|-------|------|
| Critical | Slack + PagerDuty（電話） | 即時対応必須 |
| Warning | Slack + メール | 確認必須 |
| Info | Slack | 情報共有 |

### 通知ルール

| 時間帯 | Critical | Warning | Info |
|-------|----------|---------|------|
| 営業時間（9-18時） | Slack + 電話 | Slack + メール | Slack |
| 夜間・休日 | Slack + 電話 | Slack | - |

### 通知先設定

```yaml
# PagerDuty設定例
escalation_policy:
  - level: 1
    delay: 5  # 5分後にエスカレーション
    targets:
      - 運用担当
  - level: 2
    delay: 15
    targets:
      - 開発責任者
  - level: 3
    delay: 30
    targets:
      - PM
```

---

## ダッシュボード

### 概要ダッシュボード

| パネル | 内容 |
|--------|------|
| サービス稼働状況 | 各サービスの死活状態 |
| リクエスト数 | 時系列グラフ |
| エラー率 | 時系列グラフ |
| レイテンシ | p50, p95, p99 |
| インフラリソース | CPU, メモリ使用率 |

### DB ダッシュボード

| パネル | 内容 |
|--------|------|
| 接続数 | 現在の接続数 |
| クエリ実行数 | 読み取り/書き込み |
| スロークエリ | 1秒以上のクエリ |
| レプリケーション遅延 | ラグ時間 |

---

## CloudWatch アラーム設定

### CPU使用率アラーム

```json
{
  "AlarmName": "production-cpu-high",
  "ComparisonOperator": "GreaterThanThreshold",
  "EvaluationPeriods": 3,
  "MetricName": "CPUUtilization",
  "Namespace": "AWS/ECS",
  "Period": 60,
  "Statistic": "Average",
  "Threshold": 90,
  "ActionsEnabled": true,
  "AlarmActions": [
    "arn:aws:sns:ap-northeast-1:xxx:alerts"
  ],
  "Dimensions": [
    {
      "Name": "ClusterName",
      "Value": "production"
    },
    {
      "Name": "ServiceName",
      "Value": "app"
    }
  ]
}
```

### 5xxエラー率アラーム

```json
{
  "AlarmName": "production-5xx-high",
  "ComparisonOperator": "GreaterThanThreshold",
  "EvaluationPeriods": 2,
  "Metrics": [
    {
      "Id": "e1",
      "Expression": "(m1/m2)*100",
      "Label": "5xx Error Rate"
    },
    {
      "Id": "m1",
      "MetricStat": {
        "Metric": {
          "Namespace": "AWS/ApplicationELB",
          "MetricName": "HTTPCode_ELB_5XX_Count"
        },
        "Period": 60,
        "Stat": "Sum"
      }
    },
    {
      "Id": "m2",
      "MetricStat": {
        "Metric": {
          "Namespace": "AWS/ApplicationELB",
          "MetricName": "RequestCount"
        },
        "Period": 60,
        "Stat": "Sum"
      }
    }
  ],
  "Threshold": 5,
  "AlarmActions": [
    "arn:aws:sns:ap-northeast-1:xxx:alerts"
  ]
}
```

---

## メンテナンス

### アラート一時停止

```bash
# 計画メンテナンス時のアラート停止
aws cloudwatch disable-alarm-actions \
  --alarm-names production-cpu-high production-5xx-high

# メンテナンス終了後に再開
aws cloudwatch enable-alarm-actions \
  --alarm-names production-cpu-high production-5xx-high
```

### 閾値調整

閾値は以下の観点で定期的に見直す：
- 誤報（false positive）が多くないか
- 重要なアラートを見逃していないか
- 新機能追加に伴う調整

---

## トラブルシューティング

### アラートが来ない

1. SNSトピックのサブスクリプション確認
2. メール確認済みか確認
3. CloudWatchアラームの状態確認

### 誤報が多い

1. 閾値の見直し
2. 評価期間の調整
3. 一時的なスパイクを除外する設定

---

**最終更新**: YYYY-MM-DD
**更新者**: {名前}
