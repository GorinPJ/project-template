# 環境構築手順

## 概要

開発環境のセットアップ手順を記載します。

---

## 前提条件

### 必要なソフトウェア

| ソフトウェア | バージョン | 用途 | インストール方法 |
|------------|-----------|------|----------------|
| Git | 2.40以上 | バージョン管理 | [公式サイト](https://git-scm.com/) |
| Docker | 24.0以上 | コンテナ環境 | [Docker Desktop](https://www.docker.com/) |
| Node.js | 20.x LTS | JavaScript実行環境 | [公式サイト](https://nodejs.org/) |
| VS Code | 最新版 | エディタ | [公式サイト](https://code.visualstudio.com/) |

### 推奨スペック

| 項目 | 最小 | 推奨 |
|------|------|------|
| CPU | 2コア | 4コア以上 |
| メモリ | 8GB | 16GB以上 |
| ディスク | 20GB空き | 50GB以上空き |

---

## セットアップ手順

### 1. リポジトリのクローン

```bash
# SSHの場合
git clone git@github.com:{organization}/{repository}.git

# HTTPSの場合
git clone https://github.com/{organization}/{repository}.git

cd {repository}
```

### 2. 環境変数の設定

```bash
# 環境変数ファイルをコピー
cp .env.example .env

# 必要に応じて値を編集
# エディタで .env を開いて編集
```

#### 設定が必要な環境変数

| 変数名 | 説明 | 例 |
|--------|------|-----|
| DB_DATABASE | データベース名 | myapp_dev |
| DB_USERNAME | DBユーザー名 | root |
| DB_PASSWORD | DBパスワード | password |
| APP_KEY | アプリケーションキー | 自動生成 |

### 3. Docker環境の起動

```bash
# コンテナをビルド・起動
docker compose up -d

# 起動確認
docker compose ps

# ログ確認
docker compose logs -f
```

### 4. 依存パッケージのインストール

```bash
# コンテナ内でコマンド実行
docker compose exec app npm install

# または
docker compose exec app composer install
```

### 5. データベースのセットアップ

```bash
# マイグレーション実行
docker compose exec app npm run db:migrate

# シードデータ投入
docker compose exec app npm run db:seed
```

### 6. 動作確認

| URL | 用途 |
|-----|------|
| http://localhost:8080 | アプリケーション |
| http://localhost:8080/api/health | ヘルスチェック |
| http://localhost:3306 | MySQL (DBクライアント用) |

---

## よく使うコマンド

### Docker操作

```bash
# コンテナ起動
docker compose up -d

# コンテナ停止
docker compose down

# コンテナ再起動
docker compose restart

# ログ確認
docker compose logs -f [サービス名]

# コンテナ内に入る
docker compose exec app bash
```

### 開発コマンド

```bash
# 開発サーバー起動
docker compose exec app npm run dev

# テスト実行
docker compose exec app npm test

# Lint実行
docker compose exec app npm run lint

# ビルド
docker compose exec app npm run build
```

### データベース操作

```bash
# マイグレーション実行
docker compose exec app npm run db:migrate

# マイグレーションロールバック
docker compose exec app npm run db:rollback

# シード実行
docker compose exec app npm run db:seed

# DBリセット（全データ削除＋再構築）
docker compose exec app npm run db:reset
```

---

## トラブルシューティング

### ポートが使用中

```
Error: Ports are not available: listen tcp 0.0.0.0:8080: bind: address already in use
```

**解決方法**:
```bash
# 使用中のプロセスを確認
lsof -i :8080

# プロセスを終了
kill -9 {PID}

# または .env でポート番号を変更
WEB_PORT=8081
```

### コンテナが起動しない

```bash
# コンテナのログを確認
docker compose logs app

# コンテナを再ビルド
docker compose build --no-cache
docker compose up -d
```

### パーミッションエラー

```bash
# 権限を修正
sudo chown -R $USER:$USER .

# または
docker compose exec app chmod -R 777 storage
```

### データベース接続エラー

```
SQLSTATE[HY000] [2002] Connection refused
```

**解決方法**:
1. DBコンテナが起動しているか確認
2. `.env` のDB接続情報を確認
3. DBコンテナを再起動

```bash
docker compose restart db
```

---

## IDE設定

### VS Code推奨拡張機能

| 拡張機能 | 用途 |
|---------|------|
| ESLint | Lint |
| Prettier | フォーマッター |
| Docker | Docker管理 |
| GitLens | Git操作 |
| Remote - Containers | コンテナ内開発 |

### 推奨設定（settings.json）

```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  }
}
```

---

## 関連ドキュメント

- [コーディング規約](./コーディング規約.md)
- [開発ガイド](./開発ガイド.md)
- [API設計](../03_設計/API設計.md)

---

**最終更新**: YYYY-MM-DD
**更新者**: {名前}
